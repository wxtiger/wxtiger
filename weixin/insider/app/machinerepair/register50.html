<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<link rel="stylesheet" type="text/css" href="/weixin/system/js/easyui/themes/bootstrap/easyui.css">
	<link rel="stylesheet" type="text/css" href="/weixin/system/js/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="/weixin/system/js/easyui/themes/color.css">
	<link rel="stylesheet" type="text/css" href="/weixin/system/js/easyui/themes/mobile.css">
	<link rel="stylesheet" type="text/css" href="/weixin/system/js/easyui/themes/body.css">
	
	<script type="text/javascript" src="/weixin/system/js/easyui/jquery.min.js"></script>
	<script type="text/javascript" src="/weixin/system/js/easyui/jquery.easyui.min.js"></script>	
	
	<script src="/weixin/system/js/weixin.tools.js?aaa=1&"></script>	
	<link rel="stylesheet" type="text/css" href="register.css"> 	
	<script src="register.js?aaa=2&"></script>	
	<title>设备报修</Title>
	
	 
</head>

<body>
<div style="display:none">	
	<input type="text" id="idCurWXID" value="" >	
	<input type="text" id="idCurName" value="" >	
	<input type="text" name="UserName" id="idUserName" value="" />
	<input type="text" name="UserMobile" id="idUserMobile" value="" />	

	<input type="text" id="idRepairStatus" value="" />	
	<input type="text" id="idFileNameList" value="" />	
	<input type="text" id="idFileNameSaveList" value="" />	
	<input type="text" id="idNextWXID" value="" />	
	<input type="text" id="idNextName" value="" />	
	<input type="text" id="idRequestWXID" value="" />	
	<input type="text" id="idRequestName" value="" />	
	<input type="text" id="idRepairID" value="" />	
	<input type="text" id="idFinishRecordNum" value="0" />	

</div>
		

  <div class="easyui-navpanel">
        <header>
            <div class="m-toolbar">
                <div class="m-title">IT设备报修<span id="idCIPIDShow"></span></div>
            </div>
			<div class="m-left" style="display:none">
                    <a href="html/help.html" class="easyui-linkbutton" iconCls="icon-help" plain="true" outline="true">帮助</a>
            </div>
			<div class="m-right" style="display:none">
                    <a href="javascript:openWinWorkflow();" class="easyui-linkbutton" iconCls="icon-reload" plain="true" outline="true">流转记录</a>
            </div>
        </header>

		
		
		<div class="easyui-tabs" id="idTab" data-options="fit:false,border:false,pill:true,justified:true,tabWidth:80,tabHeight:35">
    
		<!--1.提出问题-->
            <div title="1.提出问题" data-options="" style="color:black;">
			
				<div style="margin:10px">
					<span style="width:;"><b>保修单：</b></span>	<span id="idRepairIDShow"></span>					
				</div>
				<div style="margin:10px">
					<b>设备名：</b><span id="idMachineNameShow"></span>
				</div>
				<div style="margin:10px">
					<b>创建者：</b><span id="idSubmitNameShow"></span>
				</div>
				
				<div style="margin:10px">
					<b>执行者：</b><span id="idSolvedNameShow"></span>
				</div>
												
				<div style="margin:5px">		
					<section class="showTitle1">							
						<section style="margin:5px;">
							<span id="idSubmitComment">报修内容</span>
						</section>
					</section>
				</div>
				
				
				<div style="margin:10px">	
					<div class="products">
						<ul id="idFileList" >
							
						</ul>	
					</div>
				</div>
				
				
				
            </div>
			
		<!--2.解决问题-->
			<div title="2.解决问题" data-options="" >
                <div style="margin:10px;height:300px">
					<ul id="idShowFinishRecord" class="easyui-datalist" style="" data-options="
										height:'100%',
										rownumbers: true,  
										fit: false,
										nowrap:false,
										lines: true,
										border: true
							">	
					</ul>
				</div>
				
            </div>
		
		<!--3.验证结果-->			
			<div title="3.验证结果" data-options="iconCls:'icon-ok'" >
			<br>
                <div style="margin:20px;">
					1、服务满意度评价（处理结果的质量）：<b><span id="idVerifyResult1" style="color:red">5</span></b><br><br>
					 <input class="easyui-slider" style="width:90%" data-options="showTip:true,min:1,max:5,value:5,
							onChange:function(newValue,oldValue){
								$('#idVerifyResult1').html(newValue);
							}">
				</div>
				<div style="margin:20px;">
					2、服务满意度评价（处理响应的时间）：<b><span id="idVerifyResult2" style="color:red">5</span></b><br>	<br>
					 <input class="easyui-slider" style="width:90%" data-options="showTip:true,min:1,max:5,value:5,
							onChange:function(newValue,oldValue){
								$('#idVerifyResult2').html(newValue);
							}">
				</div>
				<div style="margin:20px">
					 <input class="easyui-textbox" id="idVerifyComment" style="width:95%;height:100px" data-options="label:'3、备注说明:',multiline:true">
				</div>
				
				<div style="margin:20px;text-align:center">
					<p><br></p>
				</div>
				<div style="margin:10px;text-align:center">
					<a id="idBtnBack" href="javascript:doSubmit_Back();" class="easyui-linkbutton c4" style="width:30%" data-options="iconCls:'icon-back',iconAlign:'top'">退回处理</a>&nbsp;&nbsp;
				&nbsp;&nbsp;&nbsp;
					<a id="idBtnOK" href="javascript:doSubmit_OK()" class="easyui-linkbutton c8" style="width:30%" data-options="iconCls:'icon-ok',iconAlign:'top'">确认完成</a>
				</div>
				<div style="margin:10px;text-align:center">
					<p></p>
				</div>
				
            </div>
			
			
			
        </div>
		
		
	 </div>	
	
<script>

//00 初始化
$(document).ready(function(){ 
	　　
	//01 读取参数
	doReadQuery();
	//doOpen_setEvent();
	
	//02 读取当前用户资料
	doReadUser();
	
	//03 读取报修资料
	doReadRepair();
	
	//04 判断处理权限,绑定事件
	doSetEvent();
	
	//05 显示完成记录
	doShowFinishRecord()
		
}); 


//填写完成情况
function doSubmit_Back(){
	//点击注册按钮，执行此函数
	//获得当前用户的微信ID
	
	var strReturn = "";
	
	strReturn += '"CurWXID":"'+$("#idCurWXID").val()+'",';
	strReturn += '"CurName":"'+$('#idCurName').val()+'",';	
	strReturn += '"RepairID":"'+$('#idRepairID').val()+'",';
	strReturn += '"SubmitType":"Return",';	
	
	//VerifyComment
	sValue = $('#idVerifyComment').textbox('getValue');
	if(sValue == ''){
		$.messager.alert('字段错误','请输入退回处理者的备注说明!','error');
		return;
	}
	strReturn += '"VerifyComment":"'+StringDelBad(sValue)+'",';

	strReturn += '"OK":"1"';	
	$.messager.confirm('提交', '您确定退回给处理者?', function(r){
		if (r){
			strReturn = encodeURI('{'+strReturn+'}');
			saveBody_Back(strReturn);
			return;
		}
    });
			
	return;
}

//保存处理者
function saveBody_Back(sBody){
	ajaxLoading('');
	
	var requestURL = "php/doRepairSubmit50.php?";
	
	$.ajax({
		url:requestURL,
		type:'POST', data:sBody,dataType:'text', 
		error:function (XMLHttpRequest, textStatus, errorThrown) {
                ajaxLoadEnd();	
	　　　　　  alert("提交失败，请重新试试，"+textStatus);
				return;
        },
		complete:function(XMLHttpRequest,status){
	　　　　if(status=='timeout'){
	 　　　　　 ajaxLoadEnd();	
	　　　　　  alert("服务器无响应，请重新试试");
				return;
	　　　　}
　　	},
		success:function(sText,textStatus,jqXHR){
			ajaxLoadEnd();	
			//alert(sText);
			objJson = JSON.parse(decodeURI(sText));
			
			if(objJson.errcode != 0){;
				alert("保存有问题，请重新提交:"+objJson.errmsg);
				return;									
			}	
			
			alert("已退回给处理者");
			location.href='main.html';
			//WeixinJSBridge.call('closeWindow');	
			return;			
		}
	})
}

//完成处理
function doSubmit_OK(){
	//点击注册按钮，执行此函数
	//获得当前用户的微信ID
	
	//判断当前用户是否是建议者，如果不是，则灰色按钮，
	sWXID = $("#idWXID").val();
	//、、sRequest = $('#idRequestWXID').val();
	//if(sWXID != sRequest && sWXID != ''){
	//	$('#idBtnOK').linkbutton('disable');
	//	$.messager.alert('Error','只能由建议者('+$('#idRequestName').val()+')确认。','info');
	//	return;
	//}	
			
	var strReturn = "";
	
	strReturn += '"CurWXID":"'+$("#idCurWXID").val()+'",';
	strReturn += '"CurName":"'+$('#idCurName').val()+'",';	
	strReturn += '"RepairID":"'+$('#idRepairID').val()+'",';
	strReturn += '"SubmitType":"Completed",';	
	
	strTemp = $('#idVerifyResult1').html()+'|'+$('#idVerifyResult2').html();
	strReturn += '"VerifyResult":"Completed|'+strTemp+'",';
	
	//VerifyComment
	sValue = $('#idVerifyComment').textbox('getValue');
	strReturn += '"VerifyComment":"'+StringDelBad(sValue)+'",';
	
	
	strReturn += '"OK":"1"';
	
	$.messager.confirm('提交', '您确定完成处理了吗?', function(r){
		if (r){
			strReturn = encodeURI('{'+strReturn+'}');
			saveBody_OK(strReturn);
			return;
		}
    });
			
	return;
}

//02 保存处理者
function saveBody_OK(sBody){
	ajaxLoading('');
	
	var requestURL = "php/doRepairSubmit50.php?";
	
	$.ajax({
		url:requestURL,
		type:'POST', data:sBody,dataType:'text', 
		error:function (textStatus) {
                ajaxLoadEnd();	
	　　　　　  alert("提交失败，请重新试试，"+textStatus);
				return;
        },
		complete:function(XMLHttpRequest,status){ //请求完成后最终执行参数
	　　　　if(status=='timeout'){//超时,status还有success,error等值的情况
	 　　　　　 ajaxLoadEnd();	
	　　　　　  alert("服务器无响应，请重新试试");
				return;
	　　　　}
　　	},		
		success:function(sText,textStatus,jqXHR){
			ajaxLoadEnd();	
			//alert(sText);
			objJson = JSON.parse(decodeURI(sText));
			
			if(objJson.errcode != 0){;
				alert("保存有问题，请重新提交:"+objJson.errmsg);
				return;									
			}	
			alert('已完成处理');
			location.href='main.html';
			return;			
		}
	})
}



</script>
</body>
</html>
